name: Deploy

on:
  push:
    branches: [main]
  workflow_dispatch:

jobs:
  deploy:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v3

      - name: Deploy to production server
        uses: appleboy/ssh-action@master
        with:
          host: ${{ secrets.PROD_EC2_PUBLIC_IP }}
          username: ${{ secrets.PROD_EC2_SSH_USERNAME }}
          key: ${{ secrets.PROD_EC2_SSH_PRIVATE_KEY }}
          script: |
            # Ensure directory exists
            mkdir -p /home/ubuntu/qbit-ops
            
            # Check if repository exists and is a git repo, otherwise clone it
            if [ -d /home/ubuntu/qbit-ops/.git ]; then
              echo "Repository exists, pulling latest changes..."
              cd /home/ubuntu/qbit-ops
              git fetch origin
              git reset --hard origin/main
            else
              echo "Repository not found, cloning..."
              cd /home/ubuntu
              # Remove directory if it exists but is not a git repo
              rm -rf qbit-ops
              # Clone the repository
              git clone https://github.com/${{ github.repository }}.git qbit-ops
              cd /home/ubuntu/qbit-ops
              git checkout main
            fi
            
            # Ensure we're in the project directory
            cd /home/ubuntu/qbit-ops
            
            cat > .env << EOF
            MONGO_URI=${{ secrets.CHAT_APP_MONGO_URI }}
            MONGO_OPS_URI=${{ secrets.MONGO_OPS_URI }}
            JWT_SECRET=${{ secrets.CHAT_APP_JWT_SECRET }}
            JWT_REFRESH_SECRET=${{ secrets.CHAT_APP_REFRESH_SECRET }}
            ADMIN_JWT_SECRET=${{ secrets.OPS_APP_JWT_SECRET }}
            ALLOWED_ORIGINS=https://ops.qbit42.ai,https://chat.qbit42.ai
            TRUST_PROXY=1
            SESSION_EXPIRY=900000
            REFRESH_TOKEN_EXPIRY=604800000
            COOKIE_DOMAIN=.qbit42.ai
            NODE_ENV=production
            PORT=4001
            QBIT_CHAT_URL=https://chat.qbit42.ai
            EOF
            
            chmod +x scripts/*.sh
            ./scripts/deploy.sh